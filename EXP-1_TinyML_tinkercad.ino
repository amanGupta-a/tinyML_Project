#include <Adafruit_LiquidCrystal.h>
#include <avr/pgmspace.h>

// Initialize LCD
Adafruit_LiquidCrystal lcd_1(0);

// --- 1. WEIGHTS STORED IN FLASH (PROGMEM) ---
const float layer0_weights[64][12] PROGMEM = {
  {0.0000f, 0.0000f, 0.0000f, 0.0000f, -0.0000f, -0.0000f, -0.0000f, 0.0000f, 0.0000f, -0.0000f, -0.0000f, 0.0000f},
  {-0.9163f, 0.6811f, 1.9082f, 0.5451f, -0.6595f, -1.3552f, 0.7525f, 0.6115f, -0.8501f, 0.2940f, -1.8651f, 0.1352f},
  {-0.4026f, 0.9490f, 0.9240f, -0.5244f, 0.7669f, -0.6840f, -0.2636f, 0.2266f, 0.6721f, -0.4397f, 0.0589f, 0.0966f},
  {0.8121f, 0.5682f, -0.2472f, -0.2625f, -0.1109f, -0.4465f, 0.3405f, 0.0426f, 0.1953f, 0.6464f, 0.3129f, 0.9123f},
  {0.8498f, 0.5730f, 0.0912f, -0.3491f, 0.8889f, -0.2887f, 0.7404f, -0.0732f, -0.3350f, 1.1265f, -1.0428f, 0.2844f},
  {0.2741f, 1.0233f, 0.7150f, -0.0172f, -0.7820f, -0.5524f, 0.1325f, 0.9826f, 0.1283f, -0.3329f, 0.2381f, -0.0005f},
  {-0.1264f, 1.4979f, 1.1478f, -0.2398f, -0.5979f, -1.8287f, 0.2644f, -0.5820f, -1.2250f, -0.5583f, 0.1391f, -0.5396f},
  {-0.2106f, -0.6847f, 0.0742f, -0.2142f, 0.2688f, 0.3091f, 0.2944f, -0.4754f, -0.6239f, 0.3101f, 0.9381f, 0.6200f},
  {0.7802f, -0.2150f, -0.8900f, -0.5811f, 0.9538f, 1.0992f, -0.9344f, 0.7040f, 0.0562f, -1.0804f, -0.2816f, -0.9560f},
  {-0.7738f, 0.0272f, -0.3022f, -0.9904f, 0.8353f, -0.4627f, 0.8540f, -0.1050f, 1.1059f, 0.8998f, -0.2801f, 0.8819f},
  {0.1690f, 0.7638f, 0.3197f, -0.7321f, 0.5448f, -0.4023f, 0.4532f, 0.0037f, 0.7365f, 0.1826f, -0.4671f, 0.0236f},
  {0.3993f, 0.7028f, 0.6398f, -0.0540f, 0.5395f, -0.1433f, 0.0238f, -0.0878f, -0.0183f, 0.3566f, -0.0834f, 0.2646f},
  {-0.2044f, 0.2858f, 0.4114f, -0.0406f, -0.4164f, -0.8828f, 0.7603f, 0.4744f, -0.1695f, 1.0012f, 0.2561f, 0.9217f},
  {0.5713f, 0.0195f, -0.2797f, -0.3169f, 0.1819f, 0.1528f, 0.1000f, 0.6783f, 0.4664f, 0.6111f, -0.1477f, 0.1175f},
  {0.4723f, 0.3323f, -0.2837f, -1.3120f, 0.1747f, -0.0029f, 0.3376f, -0.1256f, 0.1001f, 0.7317f, -0.6480f, -0.6257f},
  {-0.1141f, -0.3452f, 0.2981f, -0.3995f, 0.5596f, -0.2156f, 0.5021f, -1.0312f, 0.9811f, -0.0313f, 0.5231f, -0.4443f},
  {-0.2361f, 0.6040f, -0.7353f, 1.3382f, -1.3392f, -0.0546f, 0.1347f, 1.5259f, -1.3108f, -0.9425f, 1.3008f, 1.4334f},
  {-0.0339f, 0.0248f, -0.8193f, 0.6520f, -0.0643f, -0.0286f, -0.3240f, 0.4122f, 0.3220f, -0.6165f, 0.1458f, 0.2939f},
  {0.1311f, 0.2769f, -0.0193f, 0.2067f, 0.9395f, 0.7402f, -1.1098f, -0.4724f, 0.3208f, -0.5729f, 0.6524f, -0.2945f},
  {0.7077f, 0.3390f, -0.0709f, 0.7306f, -0.1693f, 0.5309f, -0.9520f, 0.2792f, -0.6663f, -1.1530f, 1.3507f, -0.1170f},
  {0.1896f, -0.0341f, -0.7991f, -0.2659f, -0.9153f, 0.4011f, 1.1016f, 0.9010f, 0.7643f, 0.4707f, 1.0269f, 0.7607f},
  {0.8777f, -1.0692f, -1.0594f, -1.0421f, 1.2146f, -0.0905f, 0.5324f, -0.2906f, -0.0552f, 0.7326f, 0.9771f, 0.5615f},
  {0.1378f, -1.0715f, -0.8410f, -0.3316f, 0.1919f, 0.9563f, 0.4850f, 0.1966f, -0.7724f, 1.4040f, 0.6486f, 1.1609f},
  {-0.4028f, -0.4442f, 0.1722f, 0.6360f, 0.8809f, 0.5092f, 0.3882f, -0.7360f, 0.2165f, -0.5220f, 0.4748f, -0.4242f},
  {-2.0832f, -1.3758f, -0.4053f, 1.6583f, -0.7891f, -0.5096f, 1.0324f, 0.5873f, -1.2833f, -0.3028f, 1.6122f, 0.9350f},
  {0.4300f, -0.0543f, 0.0773f, 0.8456f, 0.8516f, 0.0818f, -0.2428f, -0.5538f, -0.4222f, -0.6903f, -0.1266f, -0.7412f},
  {0.3742f, 0.1925f, 0.3020f, 0.5759f, 0.8405f, -0.1198f, -0.2152f, -0.7896f, -0.2955f, -0.8098f, 1.1108f, -0.7500f},
  {1.3841f, 0.5316f, -0.7576f, -0.3135f, 0.4966f, 0.7825f, 0.1418f, 0.2950f, 0.0446f, -0.7530f, 0.6489f, -1.2344f},
  {0.2775f, 0.9942f, -0.1234f, -0.3317f, -0.4070f, -0.2103f, 0.9652f, 0.3422f, -0.2259f, -0.5391f, 0.5325f, -0.5981f},
  {0.1662f, -0.0876f, -0.0604f, -0.4662f, 0.2910f, 0.0692f, -0.0183f, -0.6587f, 0.1566f, 0.2386f, 1.5156f, 0.2323f},
  {-0.7986f, -1.1252f, -0.1453f, 0.3012f, 1.1287f, -0.0545f, 0.6601f, -0.5539f, 0.1106f, -0.3078f, 1.6540f, 0.4861f},
  {-0.5421f, -0.2933f, -0.5401f, 0.3558f, 0.5387f, 0.5307f, -0.1855f, 0.0095f, 0.0000f, -0.6228f, 0.4634f, -0.3811f},
  {-0.0000f, 0.0000f, 0.0000f, -0.0000f, -0.0000f, -0.0000f, -0.0000f, -0.0000f, 0.0000f, 0.0000f, -0.0000f, -0.0000f},
  {-0.2781f, -0.4662f, 1.7048f, 0.7386f, 0.2025f, 0.4847f, -0.1499f, -0.0801f, -0.4265f, 0.2047f, 0.1009f, -0.0993f},
  {0.5649f, -0.2796f, 0.4890f, 0.6154f, 0.5001f, 0.3653f, 0.4407f, -0.1609f, -0.6638f, -0.5155f, 0.7241f, -0.2502f},
  {0.3330f, 0.5511f, -0.4126f, -0.6928f, 0.2515f, 0.7289f, 0.4178f, 0.3437f, -0.0255f, 0.1928f, -0.0251f, -0.5825f},
  {-0.5034f, -0.4064f, 0.1102f, -0.0022f, -0.3759f, 0.5553f, 1.3368f, 0.6088f, -0.2343f, 0.2340f, -0.0328f, -0.3592f},
  {0.2735f, -0.2781f, 0.9130f, 0.9146f, -0.1348f, -0.2133f, 0.7285f, -0.1027f, -0.0235f, -0.2533f, 0.9570f, -0.0832f},
  {-0.4760f, -0.6786f, 1.0824f, 1.0658f, 0.1484f, -0.7862f, 0.7080f, -0.9769f, -0.9208f, -0.8059f, 0.8617f, -0.2343f},
  {-0.0000f, -0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, -0.0000f, -0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f},
  {-0.1917f, -0.2664f, -0.3082f, 0.2225f, 0.4049f, 0.2396f, -0.0135f, 0.0407f, -0.0000f, -0.2449f, 0.3698f, -0.0705f},
  {-1.3091f, -1.4124f, -0.5858f, 0.1606f, 0.9406f, 1.0420f, 0.6242f, 0.1730f, -0.8134f, -0.3453f, 0.4841f, 0.4998f},
  {-0.2847f, -0.7563f, 0.8651f, 0.5422f, 0.4721f, 1.4161f, -1.0583f, 0.3139f, -0.3754f, 0.9068f, 0.1566f, -0.1967f},
  {-1.6220f, -1.0760f, 1.3544f, -0.3634f, -0.1487f, 1.3948f, -0.4553f, 1.1050f, 0.4889f, 0.0178f, 1.0421f, 0.3766f},
  {-0.5744f, -0.5839f, 0.6484f, 0.6634f, 0.7294f, 0.7122f, 0.6772f, 0.8156f, -0.2109f, -0.5783f, 0.0296f, -0.7532f},
  {1.0472f, -0.0619f, 0.3997f, 0.9310f, 0.6023f, 0.0899f, 0.5823f, 0.6063f, 0.2956f, -0.3186f, -0.7304f, -0.5316f},
  {0.3799f, -0.1986f, 0.8595f, 0.7051f, -0.0056f, 0.2087f, 0.5861f, -0.3431f, 0.7251f, 0.5917f, -1.4488f, -1.2375f},
  {-0.5993f, 0.1052f, 0.5001f, -0.1314f, -0.1214f, 0.4086f, -0.7916f, -0.4738f, 0.6416f, 0.9516f, -0.0466f, -0.1981f},
  {-0.4909f, 0.2185f, 0.1114f, -0.4888f, -0.2224f, 0.2835f, -0.0298f, -0.2590f, 0.8211f, 0.1154f, -0.1732f, 0.2534f},
  {-1.0050f, -0.6486f, -1.2928f, 0.0440f, 0.5006f, 0.3159f, 0.6131f, -0.2205f, 0.6330f, -0.6201f, 0.5625f, -0.0572f},
  {0.2558f, 0.2820f, 0.1356f, 0.4448f, 0.0232f, 0.7762f, -0.6273f, 0.0397f, 0.3612f, 0.5388f, -0.3506f, 0.2824f},
  {-0.7346f, -0.1194f, 0.6430f, 0.3583f, -0.6636f, 0.1443f, -0.1003f, -0.4859f, -0.1107f, 0.4711f, 0.5608f, 1.0330f},
  {-0.3022f, -0.0056f, 0.0266f, 0.9626f, -0.3189f, 0.0121f, -0.6172f, 0.3901f, -0.4445f, 0.1105f, -0.2457f, 0.9930f},
  {0.1228f, 0.7993f, 0.3089f, 0.2090f, -0.4217f, 0.7420f, -0.9499f, 0.2953f, 0.5047f, 0.6849f, -0.9499f, 0.4299f},
  {0.7652f, 0.4317f, -0.4265f, -0.2447f, -0.6778f, 0.8214f, 0.1526f, -0.2868f, 0.7128f, 1.3452f, -1.1075f, 0.1657f},
  {0.3171f, 1.2238f, -1.4802f, 0.2267f, -0.5962f, -0.6548f, -1.1425f, 0.6767f, -0.1627f, -1.1954f, 1.4707f, 0.8963f},
  {-0.1458f, 0.1355f, 0.2466f, -0.2136f, -0.3529f, -0.2492f, -0.1486f, -0.2609f, 0.4213f, 0.3750f, -0.4982f, 0.4684f},
  {-0.6751f, 1.1051f, 1.9145f, -0.7416f, -0.5829f, -0.8961f, 0.0393f, 0.9199f, -0.0179f, 0.8890f, -2.4652f, 0.5895f},
  {-0.4274f, 0.8876f, 0.7238f, -0.2908f, 0.2075f, -1.3117f, 0.3694f, -0.1901f, 0.4463f, -0.1461f, -0.3913f, 0.6286f},
  {0.5588f, 1.0284f, 0.1376f, 0.2014f, 0.3892f, -0.2177f, -0.4006f, 0.2732f, 0.6783f, 0.0923f, -0.4004f, 0.6930f},
  {0.6172f, 0.7171f, -0.5198f, 0.2569f, 0.2140f, 0.7332f, -0.4403f, 0.5006f, -0.4442f, 0.0900f, -0.3143f, 0.4018f},
  {0.3207f, 0.9673f, -0.0664f, 0.2863f, -0.7067f, 0.7814f, -0.4786f, -0.0521f, -0.1671f, 0.4143f, 0.0011f, 0.4119f},
  {-0.4713f, 0.6730f, -0.4977f, -0.0878f, -1.0658f, 0.5210f, -0.8186f, 0.0691f, -0.8528f, 1.0502f, 0.0420f, 1.1552f},
  {-0.6967f, 0.5176f, -0.7449f, 0.1528f, -1.1822f, -0.2417f, -1.6329f, 0.8660f, -0.3967f, -0.1044f, 1.1340f, 1.0260f}
};
const float layer0_biases[12] PROGMEM = {-0.1753f, 0.0980f, 0.2924f, 0.1321f, 0.4172f, 0.3654f, 0.5422f, -0.1962f, -0.0072f, 0.4803f, 0.2783f, 0.1237f};
const float layer1_weights[12][10] PROGMEM = {
  {0.7614f, -0.2178f, -1.8140f, 0.4788f, -1.4860f, 0.2033f, -0.1289f, -1.1039f, 0.3006f, 1.3066f},
  {-1.3128f, 0.2268f, 0.2998f, 0.5645f, -1.7019f, 1.3886f, 0.0085f, -0.7636f, 0.1006f, 0.7705f},
  {0.4927f, -0.2863f, -0.1376f, -0.4515f, -0.0922f, 1.3838f, 0.9811f, 1.2890f, -0.7973f, -2.1567f},
  {1.0317f, 0.4967f, -1.8587f, 0.5289f, 1.3234f, -0.0238f, 0.8121f, -0.7465f, -1.4419f, -1.4757f},
  {1.0588f, -1.5518f, -1.3684f, -1.0223f, 0.6392f, 0.6361f, -0.7369f, -0.1734f, 0.8330f, 0.3465f},
  {-0.8930f, 0.1481f, 0.0804f, -0.9937f, 0.6514f, -1.4193f, 1.4471f, -1.3447f, 1.1988f, -0.8635f},
  {-2.1275f, -0.1700f, -1.1505f, 1.2385f, 0.6239f, -0.9459f, -1.6388f, 1.4201f, -0.7480f, 0.0698f},
  {-1.3212f, 0.9550f, -0.0255f, 0.6249f, -0.3896f, -0.5648f, -0.9764f, -0.5448f, 0.6881f, -1.3161f},
  {-0.5766f, -2.3411f, 1.1594f, -0.1861f, 1.0726f, 0.2524f, -1.8571f, -0.9241f, 0.5010f, 0.3287f},
  {0.3830f, -1.2411f, 1.3945f, 0.5375f, -1.8633f, -1.5042f, 0.0516f, 0.4191f, -0.0585f, -0.4296f},
  {-0.4272f, 1.2175f, -0.7494f, -2.7997f, 1.0381f, -1.0535f, -0.5309f, 0.5529f, -0.8040f, 0.2512f},
  {0.9279f, 0.1677f, 1.5771f, -0.0385f, -1.1165f, -1.1186f, -1.7822f, -0.1457f, -1.3385f, -0.0277f}
};
const float layer1_biases[10] PROGMEM = {-0.1224f, -0.8463f, -0.1097f, 0.0517f, 0.2087f, 0.4317f, 0.1561f, -0.2909f, -0.0162f, -0.2726f};

// --- 2. INPUT DATA ARRAY ---
float canvas[64];

void setup() {
  Serial.begin(9600);
  Serial.setTimeout(50); 
  lcd_1.begin(16, 2);
  lcd_1.print("OCR System Ready");
  Serial.println("--- System Ready: Send 64 Pixels ---");
}

// --- 3. INFERENCE ENGINE (Reads from Flash) ---
int predict(float* input) {
  float hidden[12];
  
  // Layer 1: Input to Hidden
  for (int j = 0; j < 12; j++) {
    // Start with bias from PROGMEM
    hidden[j] = pgm_read_float(&layer0_biases[j]); 
    for (int i = 0; i < 64; i++) {
      float w = pgm_read_float(&layer0_weights[i][j]);
      // CRITICAL: Divide by 16.0 to match the Python training scale
      hidden[j] += (input[i] / 16.0f) * w; 
    }
    if (hidden[j] < 0) hidden[j] = 0; // ReLU activation
  }

  float output[10];
  int best_digit = 0;
  float max_val = -10000.0;

  // Layer 2: Hidden to Output
  for (int j = 0; j < 10; j++) {
    output[j] = pgm_read_float(&layer1_biases[j]);
    for (int i = 0; i < 12; i++) {
      float w = pgm_read_float(&layer1_weights[i][j]);
      output[j] += hidden[i] * w;
    }
    
    // Find highest score
    if (output[j] > max_val) {
      max_val = output[j];
      best_digit = j;
    }
  }
  return best_digit;
}

// --- 4. DATA RECEIVER LOOP ---
void loop() {
  static int count = 0;

  if (Serial.available() > 0) {
    float val = Serial.parseFloat();
    
    // Only accept 64 values
    if (count < 64) {
      canvas[count] = val;
      count++;
      
      // Update LCD/Serial every 8 pixels to show progress
      if (count % 8 == 0) {
        lcd_1.setCursor(0, 1);
        lcd_1.print("Read: ");
        lcd_1.print(count);
        lcd_1.print("/64  ");
        
        Serial.print("Progress: ");
        Serial.print(count);
        Serial.println("/64");
      }
    }

    // Once full, run the "Brain"
    if (count >= 64) {
      lcd_1.clear();
      lcd_1.print("Thinking...");
      
      int result = predict(canvas);
      
      lcd_1.setCursor(0, 1);
      lcd_1.print("Result: ");
      lcd_1.print(result);
      
      Serial.print("--- DONE! PREDICTED DIGIT: ");
      Serial.println(result);
      
      count = 0; // Reset for next image
      while(Serial.available() > 0) Serial.read(); // Clear junk
    }
  }
}